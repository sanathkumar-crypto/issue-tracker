{% extends "base.html" %}

{% block title %}All Issues - Issue Tracker{% endblock %}
{% block page_title %}All Issues{% endblock %}

{% block content %}
<div class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-8">
    <button id="toggle-add-issue-form-btn" class="w-full flex justify-between items-center text-left py-3 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
        <span class="text-lg font-semibold">Log a New Issue</span>
        <svg id="form-chevron" class="w-6 h-6 transition-transform transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
    </button>
    <div id="add-issue-collapsible" class="collapsible-content">
        <form method="POST" action="{{ url_for('create_issue') }}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-6">
            <div>
                <label for="hospitalUnit" class="block text-sm font-medium text-slate-700">Hospital Unit</label>
                {% if hospitals %}
                <select id="hospitalUnit" name="hospitalUnit" required 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select Hospital</option>
                    {% for hospital in hospitals %}
                    <option value="{{ hospital.name }}" data-zone="{{ hospital.zone or '' }}">{{ hospital.name }}</option>
                    {% endfor %}
                </select>
                {% else %}
                <div class="mt-1 space-y-2">
                    <input type="text" id="hospitalUnit" name="hospitalUnit" required 
                           class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter hospital name">
                    <p class="text-xs text-slate-500">No hospitals configured. Add hospitals in Admin â†’ Hospital Management.</p>
                </div>
                {% endif %}
            </div>
            <div>
                <label for="zone" class="block text-sm font-medium text-slate-700">Zone</label>
                <input type="text" id="zone" name="zone" readonly 
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md bg-slate-100">
            </div>
            <div>
                <label for="priority" class="block text-sm font-medium text-slate-700">Priority</label>
                <select id="priority" name="priority" required 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option>Low</option>
                    <option selected>Medium</option>
                    <option>High</option>
                    <option>Critical</option>
                </select>
            </div>
            <div>
                <label for="main-category" class="block text-sm font-medium text-slate-700">Main Category</label>
                <select id="main-category" name="mainCategory" required 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="sub-category" class="block text-sm font-medium text-slate-700">Sub-Category</label>
                <select id="sub-category" name="subCategory" 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled>
                    <option value="">Select sub-category</option>
                </select>
                <input type="text" id="other-sub-category" name="otherSubCategory" 
                       class="mt-1 hidden w-full px-3 py-2 border-slate-300 rounded-md" 
                       placeholder="Please specify">
                <input type="hidden" id="category" name="category">
            </div>
            <div>
                <label for="taskName" class="block text-sm font-medium text-slate-700">Task Name</label>
                <input type="text" id="taskName" name="taskName" required 
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="lg:col-span-3">
                <label for="description" class="block text-sm font-medium text-slate-700">Description</label>
                <textarea id="description" name="description" rows="3" required 
                          class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label for="mainOwner" class="block text-sm font-medium text-slate-700">Main Owner</label>
                <select id="mainOwner" name="mainOwner" required 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select Owner</option>
                    {% for member in team_members %}
                    <option value="{{ member.name }}">{{ member.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="coOwner1" class="block text-sm font-medium text-slate-700">Co-owner 1 (Optional)</label>
                <select id="coOwner1" name="coOwner1" 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">None</option>
                    {% for member in team_members %}
                    <option value="{{ member.name }}">{{ member.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="coOwner2" class="block text-sm font-medium text-slate-700">Co-owner 2 (Optional)</label>
                <select id="coOwner2" name="coOwner2" 
                       class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">None</option>
                    {% for member in team_members %}
                    <option value="{{ member.name }}">{{ member.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="dueDate" class="block text-sm font-medium text-slate-700">Due Date</label>
                <input type="date" id="dueDate" name="dueDate" required 
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="lg:col-span-3 flex justify-end">
                <button type="submit" class="inline-flex justify-center py-2 px-6 border text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Add Issue</button>
            </div>
        </form>
    </div>
</div>

{% if my_tasks %}
<div class="mb-4 p-3 bg-indigo-100 border-l-4 border-indigo-500 rounded-md">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3">
            <p class="text-sm text-indigo-700">Showing your open issues.</p>
        </div>
    </div>
</div>
{% endif %}

<div class="mb-4 bg-white p-4 rounded-lg shadow-sm border">
    <form method="GET" action="{{ url_for('issues') }}" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
        <div>
            <label for="search" class="block text-sm font-medium text-slate-700">Search</label>
            <div class="relative mt-1">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <input type="search" id="search" name="search" value="{{ request.args.get('search', '') }}" 
                       class="block w-full rounded-md border-slate-300 pl-10 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" 
                       placeholder="Search...">
            </div>
        </div>
        <div>
            <label for="filter-category" class="block text-sm font-medium text-slate-700">Category</label>
            <select id="filter-category" name="category" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="filter-hospital" class="block text-sm font-medium text-slate-700">Hospital</label>
            <select id="filter-hospital" name="hospital" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">All Hospitals</option>
                {% for hosp in hospitals %}
                <option value="{{ hosp.name }}" {% if request.args.get('hospital') == hosp.name %}selected{% endif %}>{{ hosp.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="filter-status" class="block text-sm font-medium text-slate-700">Status</label>
            <select id="filter-status" name="status" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">All</option>
                <option value="Open" {% if request.args.get('status') == 'Open' %}selected{% endif %}>Open</option>
                <option value="In Progress" {% if request.args.get('status') == 'In Progress' %}selected{% endif %}>In Progress</option>
                <option value="Resolved" {% if request.args.get('status') == 'Resolved' %}selected{% endif %}>Resolved</option>
                <option value="Closed" {% if request.args.get('status') == 'Closed' %}selected{% endif %}>Closed</option>
            </select>
        </div>
        <div>
            <label for="filter-zone" class="block text-sm font-medium text-slate-700">Zone</label>
            <select id="filter-zone" name="zone" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">All Zones</option>
                {% set zones = hospitals|map(attribute='zone')|select('string')|list|unique|sort %}
                {% for zone in zones %}
                {% if zone %}
                <option value="{{ zone }}" {% if request.args.get('zone') == zone %}selected{% endif %}>{{ zone }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="filter-priority" class="block text-sm font-medium text-slate-700">Priority</label>
            <select id="filter-priority" name="priority" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">All</option>
                <option value="Critical" {% if request.args.get('priority') == 'Critical' %}selected{% endif %}>Critical</option>
                <option value="High" {% if request.args.get('priority') == 'High' %}selected{% endif %}>High</option>
                <option value="Medium" {% if request.args.get('priority') == 'Medium' %}selected{% endif %}>Medium</option>
                <option value="Low" {% if request.args.get('priority') == 'Low' %}selected{% endif %}>Low</option>
            </select>
        </div>
        <div class="md:col-span-4">
            <a href="{{ url_for('issues') }}" class="inline-block py-2 px-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Clear Filters</a>
        </div>
    </form>
</div>

<div class="bg-white shadow-md rounded-lg overflow-x-auto">
    <table class="responsive-table min-w-full divide-y divide-slate-200 issues-list">
        <thead class="bg-slate-100">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Hospital / Task</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Priority</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Main Owner</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Due Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-200">
            {% if issues %}
                {% for issue in issues %}
                <tr class="clickable-row {% if issue.status == 'Closed' %}bg-slate-50{% endif %}" onclick="window.location.href='{{ url_for('issue_detail', issue_id=issue.id) }}'">
                    <td data-label="ID" class="px-6 py-4 text-sm text-slate-500">#{{ issue.id }}</td>
                    <td data-label="Hospital / Task" class="px-6 py-4 text-sm">
                        <div class="font-medium text-slate-900">{{ issue.hospitalUnit or issue.get('hospital', 'N/A') }}</div>
                        <div class="text-slate-500 text-xs">{{ issue.taskName or 'N/A' }}</div>
                    </td>
                    <td data-label="Priority" class="px-6 py-4 text-sm">
                        {% set priority_colors = {'Critical': 'bg-red-100 text-red-800', 'High': 'bg-orange-100 text-orange-800', 'Medium': 'bg-yellow-100 text-yellow-800', 'Low': 'bg-green-100 text-green-800'} %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full {{ priority_colors.get(issue.priority, 'bg-slate-100 text-slate-800') }}">
                            {{ issue.priority or 'Medium' }}
                        </span>
                    </td>
                    <td data-label="Main Owner" class="px-6 py-4 text-sm text-slate-900">{{ issue.mainOwner or 'N/A' }}</td>
                    <td data-label="Due Date" class="px-6 py-4 text-sm text-slate-500">{{ issue.dueDate or 'N/A' }}</td>
                    <td data-label="Status" class="px-6 py-4 text-sm">
                        {% set status_colors = {'Open': 'bg-blue-100 text-blue-800', 'In Progress': 'bg-purple-100 text-purple-800', 'Resolved': 'bg-yellow-100 text-yellow-800', 'Closed': 'bg-slate-100 text-slate-800'} %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full {{ status_colors.get(issue.status, 'bg-slate-100 text-slate-800') }}">
                            {{ issue.status or 'Open' }}
                        </span>
                    </td>
                    <td data-label="Actions" class="actions-cell px-6 py-4 text-sm font-medium text-right">
                        <a href="{{ url_for('issue_detail', issue_id=issue.id) }}" class="text-indigo-600 hover:text-indigo-900">View</a>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center p-16 text-slate-500">
                        <div class="flex flex-col items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <h3 class="mt-2 text-lg font-semibold text-slate-800">No Issues Found</h3>
                            <p class="mt-1 text-sm text-slate-500">Try adjusting your search or filter criteria.</p>
                        </div>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if pagination.pages > 1 %}
<div class="mt-4 flex justify-between items-center">
    <a href="?page={{ pagination.page - 1 }}{% if request.query_string %}&{{ request.query_string.decode() }}{% endif %}" 
       class="py-2 px-4 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 {% if pagination.page == 1 %}opacity-50 cursor-not-allowed{% endif %}">
        Previous
    </a>
    <span class="text-sm text-slate-600">Page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total }} total)</span>
    <a href="?page={{ pagination.page + 1 }}{% if request.query_string %}&{{ request.query_string.decode() }}{% endif %}" 
       class="py-2 px-6 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 {% if pagination.page >= pagination.pages %}opacity-50 cursor-not-allowed{% endif %}">
        Next
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
    // Toggle add issue form
    document.getElementById('toggle-add-issue-form-btn')?.addEventListener('click', () => {
        const collapsible = document.getElementById('add-issue-collapsible');
        const chevron = document.getElementById('form-chevron');
        collapsible.classList.toggle('open');
        chevron.style.transform = collapsible.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
    });

    // Category mappings from server
    const categoryMappings = {{ category_mappings | tojson }};
    const hospitals = {{ hospitals | tojson }};

    // Auto-populate zone from hospital selection
    const hospitalSelect = document.getElementById('hospitalUnit');
    if (hospitalSelect) {
        hospitalSelect.addEventListener('change', function() {
            const selected = hospitals.find(h => h.name === this.value);
            const zoneInput = document.getElementById('zone');
            if (zoneInput && selected) {
                zoneInput.value = selected.zone || '';
            } else if (zoneInput) {
                zoneInput.value = '';
            }
        });
    }

    // Handle main category change
    document.getElementById('main-category')?.addEventListener('change', function() {
        const mainCat = this.value;
        const subCategory = document.getElementById('sub-category');
        const otherSubCategory = document.getElementById('other-sub-category');
        const category = document.getElementById('category');
        
        subCategory.innerHTML = '<option value="">Select sub-category</option>';
        subCategory.disabled = !mainCat;
        otherSubCategory.classList.add('hidden');
        
        if (mainCat === 'Other') {
            subCategory.classList.add('hidden');
            subCategory.disabled = true;
            otherSubCategory.classList.remove('hidden');
            category.value = '';
        } else if (mainCat && categoryMappings[mainCat]) {
            subCategory.classList.remove('hidden');
            subCategory.disabled = false;
            categoryMappings[mainCat].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                if (sub === 'Other') {
                    option.value = '';
                }
                subCategory.appendChild(option);
            });
        }
        
        updateCategory();
    });

    // Update hidden category field
    function updateCategory() {
        const mainCat = document.getElementById('main-category').value;
        const subCat = document.getElementById('sub-category').value;
        const otherSubCat = document.getElementById('other-sub-category').value;
        const category = document.getElementById('category');
        
        if (mainCat === 'Other') {
            category.value = otherSubCat ? `Other: ${otherSubCat}` : '';
        } else if (subCat === '' && otherSubCat) {
            category.value = mainCat + ': ' + otherSubCat;
        } else if (subCat) {
            category.value = mainCat + ': ' + subCat;
        } else {
            category.value = mainCat;
        }
    }

    document.getElementById('sub-category')?.addEventListener('change', function() {
        if (this.value === '') {
            // Show other input if "Other" was selected
            const otherInput = document.getElementById('other-sub-category');
            if (otherInput) {
                otherInput.classList.remove('hidden');
            }
        } else {
            document.getElementById('other-sub-category')?.classList.add('hidden');
        }
        updateCategory();
    });
    
    document.getElementById('other-sub-category')?.addEventListener('input', updateCategory);

    // Auto-submit filter form when filters change
    const filterForm = document.querySelector('form[method="GET"][action="{{ url_for('issues') }}"]');
    if (filterForm) {
        const filterSelects = filterForm.querySelectorAll('select[name], input[name="search"]');
        filterSelects.forEach(select => {
            select.addEventListener('change', function() {
                filterForm.submit();
            });
        });
        
        // For search input, submit on Enter key or after a short delay when typing stops
        const searchInput = filterForm.querySelector('input[name="search"]');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterForm.submit();
                }, 500); // Submit after 500ms of no typing
            });
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    filterForm.submit();
                }
            });
        }
    }
</script>
{% endblock %}
